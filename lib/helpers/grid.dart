import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:firebase_cached_image/firebase_cached_image.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:gi_weekly_material_tracker/models/characterdata.dart';
import 'package:gi_weekly_material_tracker/models/commondata.dart';
import 'package:gi_weekly_material_tracker/models/materialdata.dart';
import 'package:gi_weekly_material_tracker/models/outfitdata.dart';
import 'package:gi_weekly_material_tracker/models/weapondata.dart';
import 'package:gi_weekly_material_tracker/util.dart';
import 'package:octo_image/octo_image.dart';

final FirebaseFirestore _db = FirebaseFirestore.instance;

class GridData {
  static final Map<String, Map<String, CommonData>> _staticData = {};
  static final Map<String, bool> _downloading = {};

  static Widget getAscensionImage(
    String? itemKey,
    Map<String, MaterialDataCommon>? data,
  ) {
    if (itemKey == null) {
      return Image.memory(Util.kTransparentImage, height: 16);
    }
    // debugPrint('getAscensionImage: $itemKey');

    return getImageAssetFromFirebase(
      data![itemKey]?.image ?? '',
      height: 16,
    );
  }

  static Color getCountColor(int? current, int? max, {bw = false}) {
    if (bw) {
      return (current! >= max!)
          ? Colors.green
          : (Util.themeNotifier.isDarkMode())
              ? Colors.white
              : Colors.black;
    }

    return (current! >= max!) ? Colors.greenAccent : Colors.white;
  }

  static List<QueryDocumentSnapshot> getDataListFilteredRelease(
    List<QueryDocumentSnapshot> snapshot,
  ) {
    var data = <QueryDocumentSnapshot>[];
    for (var element in snapshot) {
      var dt = element.data() as Map<String, dynamic>;
      if (dt['released']) {
        data.add(element);
      } else {
        debugPrint("Skipping ${dt['name']}");
      }
    }

    return data;
  }

  static void setStaticData(String type, QuerySnapshot? snapshot) {
    if (snapshot == null) return;
    debugPrint('Updating $type static data in memory');
    var snapData = getDataListFilteredRelease(snapshot.docs);
    var data = <String, dynamic>{};

    for (var element in snapData) {
      var dt = element.data() as Map<String, dynamic>;
      if (dt['released']) {
        data.putIfAbsent(element.id, () => dt);
      } else {
        debugPrint("Skipping ${dt['name']}");
      }
    }
    switch (type) {
      case 'characters':
        _staticData[type] = CharacterData.getList(data);
        break;
      case 'weapons':
        _staticData[type] = WeaponData.getList(data);
        break;
      case 'materials':
        _staticData[type] = MaterialDataCommon.getList(data);
        break;
      case 'outfits':
        _staticData[type] = OutfitData.getList(data);
        break;
    }
  }

  static Future<Map<String, MaterialDataCommon>?>
      retrieveMaterialsMapData() async =>
          (await _retrieveStaticData('materials'))
              as Map<String, MaterialDataCommon>?;

  static Future<Map<String, WeaponData>?> retrieveWeaponsMapData() async =>
      (await _retrieveStaticData('weapons')) as Map<String, WeaponData>?;

  static Future<Map<String, CharacterData>?>
      retrieveCharactersMapData() async =>
          (await _retrieveStaticData('characters'))
              as Map<String, CharacterData>?;

  static Future<Map<String, OutfitData>?> retrieveOutfitsMapData() async =>
      (await _retrieveStaticData('outfits')) as Map<String, OutfitData>?;

  static ImageProvider getFirebaseImage(String? url) {
    return FirebaseImageProvider(FirebaseUrl(url!), maxSize: 10000 * 10000); // 10MB
  }

  static Widget getImageAssetFromFirebase(
    imageRef, {
    double? height,
    double? width,
    double padding = 8.0,
  }) {
    if (imageRef == null) return Image.memory(Util.kTransparentImage);
    width = width ?? height;

    return FutureBuilder(
      future: Util.getFirebaseStorageUrl(imageRef),
      builder: (context, snapshot) {
        if (snapshot.hasData) {
          return Center(
            child: Padding(
              padding: EdgeInsets.all(padding),
              child: SizedBox(
                height: height,
                width: width,
                child: OctoImage(
                  placeholderBuilder: (context) => SizedBox(
                    height: height,
                    width: width,
                    child: const CircularProgressIndicator(),
                  ),
                  errorBuilder: (context, obj, trace) =>
                      const Icon(Icons.error),
                  image: getFirebaseImage(snapshot.data.toString()),
                  fit: BoxFit.fitWidth,
                  placeholderFadeInDuration: const Duration(seconds: 2),
                ),
              ),
            ),
          );
        }

        return Stack(
          children: [
            Padding(
              padding: const EdgeInsets.all(8),
              child: Center(
                child: SizedBox(
                  height: height,
                  width: width,
                  child: const CircularProgressIndicator(),
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(8),
              child: Image.memory(
                Util.kTransparentImage,
                height: height,
              ),
            ),
          ],
        );
      },
    );
  }

  static Widget getGridData(CommonData data) {
    return Card(
      color: GridUtils.getRarityColor(data.rarity, crossover: data.crossover),
      child: GridTile(
        footer: Padding(
          padding: const EdgeInsets.all(2),
          child: Text(
            data.name ?? 'Unknown',
            textAlign: TextAlign.center,
            style: const TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
        ),
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Stack(
            children: [
              getImageAssetFromFirebase(data.image),
            ],
          ),
        ),
      ),
    );
  }

  static void launchWikiUrl(BuildContext context, CommonData data) async {
    if (!await Util.launchWebPage(
      data.wiki,
      rarityColor:
          GridUtils.getRarityColor(data.rarity, crossover: data.crossover),
    )) {
      if (context.mounted) {
        Util.showSnackbarQuick(
          context,
          'Wiki Page not available for ${data.name ?? 'Unknown'}',
        );
      }
    }
  }

  static List<Widget> generateHeaderInfoLine(
    String header,
    String description,
    IconData icon,
  ) {
    return [
      Padding(
        padding: const EdgeInsets.all(8),
        child: Row(
          children: [
            Icon(icon),
            Expanded(
              child: Padding(
                padding: const EdgeInsets.only(left: 8, right: 8),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      header,
                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                        decoration: TextDecoration.underline,
                        fontSize: 16,
                      ),
                    ),
                    GridData.generateElementalColoredLine(
                      description..replaceAll('\\n', '\n'),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
      const Divider(),
    ];
  }

  static List<Widget> generateInfoLine(String? textData, IconData icon) {
    if (textData == null) return const [];

    return [
      Padding(
        padding: const EdgeInsets.all(8),
        child: Row(
          children: [
            Icon(icon),
            Expanded(
              child: Padding(
                padding: const EdgeInsets.only(left: 8, right: 8),
                child: Text(textData.replaceAll('\\n', '\n')),
              ),
            ),
          ],
        ),
      ),
      const Divider(),
    ];
  }

  static List<Widget> unreleasedCheck(
    bool released,
    String type, {
    bool hasTracking = false,
  }) {
    if (released) return [const SizedBox.shrink()];

    if (hasTracking) {
      return GridData.generateInfoLine(
        'This is an unreleased $type. Tracking is disabled and data is incomplete and subjected to change',
        Icons.warning_amber,
      );
    }

    return GridData.generateInfoLine(
      'This is an unreleased $type. Data is incomplete and subjected to change',
      Icons.warning_amber,
    );
  }

  static Widget generateElementalColoredLine(String textData) {
    debugPrint("Before: $textData");
    // Do the replacement here so that we know exactly how we are going to replace it with
    textData = GridUtils.replaceToElementColor(textData);
    debugPrint("After: $textData");

    var textSplit = textData.split('ยง');
    var textElements = <TextSpan>[];

    for (var i = 0; i < textSplit.length; i++) {
      var txt = textSplit[i];
      if (i == 0) {
        textElements.add(
          TextSpan(text: txt.replaceAll('\\n', '\n')),
        ); // Presume default
      } else {
        var effect = txt[0];
        if (effect.toLowerCase() == 'r') {
          textElements
              .add(TextSpan(text: txt.substring(1).replaceAll('\\n', '\n')));
        } else {
          textElements.add(TextSpan(
            text: txt.substring(1).replaceAll('\\n', '\n'),
            style: TextStyle(
              color: GridUtils.getElementalColor(effect),
              fontFamily: 'Product-Sans-Bold',
            ),
          ));
        }
      }
    }

    return Text.rich(TextSpan(children: textElements));
  }

  static List<Widget> getAscensionMaterialDataWidgets(
    int? qty,
    String? name,
    Map<String, MaterialDataCommon>? data,
  ) {
    return [
      getAscensionImage(name, data),
      Text((qty == 0) ? '' : qty.toString()),
      const Spacer(),
    ];
  }

  static List<Widget> generateCoWGridWidgets(
    String title,
    List<String>? names,
    String type,
    String? name,
    bool isPortrait,
  ) {
    var widgets = <Widget>[];
    widgets.add(
      Padding(
        padding: const EdgeInsets.only(left: 8),
        child: Text(
          title.toString(),
          style: const TextStyle(fontSize: 20),
        ),
      ),
    );
    var wid = GridData._getCharacterOrWeaponGrid(
      names,
      type,
      name,
      isPortrait,
    );
    if (wid == null) {
      widgets.removeLast(); // Remove title and skip
    } else {
      widgets.add(wid);
      widgets.add(const Padding(padding: EdgeInsets.only(top: 10)));
    }

    return widgets;
  }

  static Widget? _getCharacterOrWeaponGrid(
    List<String>? names,
    String type,
    String? name,
    bool isPortrait,
  ) {
    if (names == null || names.isEmpty) {
      return const SizedBox.shrink();
    }

    var characterData =
        _retrieveStaticDataQuick('characters') as Map<String, CharacterData>?;
    var weaponData =
        _retrieveStaticDataQuick('weapons') as Map<String, WeaponData>?;

    List<MapEntry<String, CommonData?>> gridEntries = [];
    gridEntries = type == 'characters'
        ? names.map((e) => MapEntry(e, characterData![e])).toList()
        : names.map((e) => MapEntry(e, weaponData![e])).toList();

    var oldCnt = gridEntries.length;
    gridEntries.removeWhere(
      (element) => element.value == null,
    ); // Remove null characters
    var newCnt = gridEntries.length;

    debugPrint('Removed ${oldCnt - newCnt} null entries');

    if (oldCnt != newCnt) {
      FirebaseCrashlytics.instance.printError(
        info:
            "ERR: Mismatched length for $name. Please check list here: $gridEntries",
      );
    }

    debugPrint("GridLen: ${gridEntries.length}");

    if (gridEntries.isEmpty) {
      // Nothing, return nothing
      return null;
    }

    return Flexible(
      child: GridView.count(
        physics: const NeverScrollableScrollPhysics(),
        shrinkWrap: true,
        crossAxisCount: (isPortrait) ? 3 : 6,
        children: gridEntries.map((entry) {
          return GestureDetector(
            onTap: () => Get.toNamed('/$type/${entry.key}'),
            child: GridData.getGridData(entry.value!),
          );
        }).toList(),
      ),
    );
  }

  static Future<Map<String, CommonData>?> _retrieveStaticData(
    String type,
  ) async {
    if (_downloading.containsKey(type) && _downloading[type]!) {
      // Wait for processing to end
      return Future.delayed(
        const Duration(seconds: 1),
        () => _retrieveStaticData(type),
      );
    }
    if (!_staticData.containsKey(type)) {
      _downloading[type] = true;
      debugPrint('Retrieving $type static data from Firestore');
      var snapshot = await _db.collection(type).get();
      _downloading[type] = false;
      setStaticData(type, snapshot);
    }

    return _staticData[type];
  }

  static Map<String, CommonData>? _retrieveStaticDataQuick(String type) {
    return _staticData[type];
  }
}

class GridUtils {
  static Color getRarityColor(int? rarity, {crossover = false}) {
    if (crossover) {
      return const Color(0xFFb73b47);
    }
    switch (rarity) {
      case 1:
        return const Color(0xFF72778b);
      case 2:
        return const Color(0xFF2a9072);
      case 3:
        return const Color(0xFF5180cc);
      case 4:
        return const Color(0xFFa256e1);
      case 5:
        return const Color(0xFFbd6932);
      default:
        return Colors.black;
    }
  }

  static Color getHeaderColor(BuildContext context) {
    if (Util.themeNotifier.isDarkMode()) {
      return Theme.of(context).colorScheme.onSurface;
    } else {
      return Theme.of(context).colorScheme.onPrimary;
    }
  }

  static String? getElementImageRef(String element) {
    switch (element.toLowerCase()) {
      case 'geo':
        return 'assets/images/elements/Element_Geo.svg';
      case 'anemo':
        return 'assets/images/elements/Element_Anemo.svg';
      case 'cryo':
        return 'assets/images/elements/Element_Cryo.svg';
      case 'dendro':
        return 'assets/images/elements/Element_Dendro.svg';
      case 'electro':
        return 'assets/images/elements/Element_Electro.svg';
      case 'hydro':
        return 'assets/images/elements/Element_Hydro.svg';
      case 'pyro':
        return 'assets/images/elements/Element_Pyro.svg';
    }

    return null;
  }

  static String getDayString(int day) {
    switch (day) {
      case 1:
        return 'Mon';
      case 2:
        return 'Tue';
      case 3:
        return 'Wed';
      case 4:
        return 'Thu';
      case 5:
        return 'Fri';
      case 6:
        return 'Sat';
      case 7:
        return 'Sun';
    }

    return 'Unknown';
  }

  static String getRomanNumberArray(int number) {
    switch (number) {
      case 0:
        return 'I';
      case 1:
        return 'II';
      case 2:
        return 'III';
      case 3:
        return 'IV';
      case 4:
        return 'V';
      case 5:
        return 'VI';
      case 6:
        return 'VII';
      case 7:
        return 'VIII';
      case 8:
        return 'IX';
      case 9:
        return 'X';
      case 10:
        return 'XI';
      case -1:
        return ''; // Disabled
      default:
        return (number + 1).toString();
    }
  }

  static Color getElementalColor(String colorChar) {
    var color = Colors.white;
    var isDarkMode = Util.themeNotifier.isDarkMode();
    switch (colorChar.toLowerCase()) {
      case 'a':
        color =
            (isDarkMode) ? const Color(0xFF6addbe) : const Color(0xFF26A684);
        break;
      case 'c':
        color =
            (isDarkMode) ? const Color(0xFF8eaece) : const Color(0xFF4878a8);
        break;
      case 'd':
        color =
            (isDarkMode) ? const Color(0xFFa0e938) : const Color(0xFF51810e);
        break;
      case 'e':
        color =
            (isDarkMode) ? const Color(0xFFc27ed8) : const Color(0xFF9336b0);
        break;
      case 'g':
        color =
            (isDarkMode) ? const Color(0xFFf8b746) : const Color(0xFFb67607);
        break;
      case 'h':
        color =
            (isDarkMode) ? const Color(0xFF5e8ff7) : const Color(0xFF0b4dda);
        break;
      case 'p':
        color =
            (isDarkMode) ? const Color(0xFFeb6f62) : const Color(0xFFbf2818);
        break;
      default:
        color = (isDarkMode) ? Colors.white : Colors.black;
        break;
    }

    return color;
  }

  static String replaceToElementColor(String textData) {
    // Effects
    textData = textData.replaceAll('Vaporize', 'ยงpVaporizeยงr');
    textData = textData.replaceAll('Overloaded', 'ยงpOverloadedยงr');
    textData = textData.replaceAll('Melt', 'ยงpMeltยงr');
    textData = textData.replaceAll('Burning', 'ยงpBurningยงr');
    textData = textData.replaceAll('Frozen', 'ยงcFrozenยงr');
    textData = textData.replaceAll('Bloom', 'ยงdBloomยงr');
    textData = textData.replaceAll('Superconduct', 'ยงeSuperconductยงr');
    textData = textData.replaceAll('Aggravate', 'ยงeAggravateยงr');
    textData = textData.replaceAll('Hyperbloom', 'ยงeHyperbloomยงr');
    textData = textData.replaceAll('Super-conduct', 'ยงeSuper-conductยงr');
    textData = textData.replaceAll('Quicken', 'ยงdQuickenยงr');
    textData = textData.replaceAll('Swirl', 'ยงaSwirlยงr');
    textData = textData.replaceAll('Crystallize', 'ยงgCrystallizeยงr');

    // Elements
    textData = textData.replaceAll('Anemo', 'ยงaAnemoยงr');
    textData = textData.replaceAll('Cryo', 'ยงcCryoยงr');
    textData = textData.replaceAll('Dendro', 'ยงdDendroยงr');
    textData = textData.replaceAll('Electro', 'ยงeElectroยงr');
    textData = textData.replaceAll('Geo', 'ยงgGeoยงr');
    textData = textData.replaceAll('Hydro', 'ยงhHydroยงr');
    textData = textData.replaceAll('Pyro', 'ยงpPyroยงr');

    // Specials
    textData = textData.replaceAll('ยงhHydroยงr-infused', 'ยงhHydro-infusedยงr');
    textData =
        textData.replaceAll('ยงeElectroยงr-Charged', 'ยงeElectro-Chargedยงr');

    // DMG
    textData = textData.replaceAll('ยงaAnemoยงr DMG', 'ยงaAnemo DMGยงr');
    textData = textData.replaceAll('ยงcCryoยงr DMG', 'ยงcCryo DMGยงr');
    textData = textData.replaceAll('ยงdDendroยงr DMG', 'ยงdDendro DMGยงr');
    textData = textData.replaceAll('ยงeElectroยงr DMG', 'ยงeElectro DMGยงr');
    textData = textData.replaceAll('ยงgGeoยงr DMG', 'ยงgGeo DMGยงr');
    textData = textData.replaceAll('ยงhHydroยงr DMG', 'ยงhHydro DMGยงr');
    textData = textData.replaceAll('ยงpPyroยงr DMG', 'ยงpPyro DMGยงr');

    textData = textData.replaceAll('AoE ยงaAnemo DMGยงr', 'ยงaAoE Anemo DMGยงr');
    textData = textData.replaceAll('AoE ยงcCryo DMGยงr', 'ยงcAoE Cryo DMGยงr');
    textData = textData.replaceAll('AoE ยงdDendro DMGยงr', 'ยงdAoE Dendro DMGยงr');
    textData =
        textData.replaceAll('AoE ยงeElectro DMGยงr', 'ยงeAoE Electro DMGยงr');
    textData = textData.replaceAll('AoE ยงgGeo DMGยงr', 'ยงgAoE Geo DMGยงr');
    textData = textData.replaceAll('AoE ยงhHydro DMGยงr', 'ยงhAoE Hydro DMGยงr');
    textData = textData.replaceAll('AoE ยงpPyro DMGยงr', 'ยงpAoE Pyro DMGยงr');

    return textData;
  }

  static TabAlignment getTabAlignment() {
    return kIsWeb ? TabAlignment.center : TabAlignment.start;
  }
}
