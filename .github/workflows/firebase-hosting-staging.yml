# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on Staging
on: 
  push:
    branches:
      - "master"

jobs:
  build_and_preview:
    runs-on: ubuntu-latest
    environment:
      name: Staging-Web
      url: ${{ steps.staging-deploy.outputs.details_url }}
    env:
      APP_BUILD_VER: web
      APP_TYPE: Web
      CI_PIPELINE_IID: ${{ github.run_number }} # Make sure when we actually build release builds it starts from 2009
      CI_COMMIT_REF_NAME: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Flutter Stable
        uses: subosito/flutter-action@v2.10.0
        with:
          channel: 'stable'
          cache: true
      - name: Cache pubspec dependencies
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.FLUTTER_HOME }}/.pub-cache
            ${{ env.PUB_CACHE }}
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
            **/.dart_tool/package_config.json
          key: build-pubspec-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: build-pubspec-
      - name: Trust GitHub Workspace
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: benjlevesque/short-sha@v2.2
        id: short-sha
        with:
          length: 8
      - name: Pre-Setup and obtain version information
        run: |
          echo $GOOGLE_SVC_DART | base64 -d > lib/firebase_options.dart
          echo $PUB_SEC_DART | base64 -d > lib/app_secrets.dart
          export GIT_COMMIT_COUNT="$(git rev-list --count HEAD)"
          echo $GIT_COMMIT_COUNT
          echo $GIT_COMMIT_SHORT_SHA
          chmod +x ./ciscripts/get_version.sh
          ./ciscripts/get_version.sh
        env:
          CI_COMMIT_SHORT_SHA: ${{ steps.short-sha.outputs.sha }}
          GOOGLE_SVC_DART: ${{ secrets.GOOGLE_SVC_DART }}
          PUB_SEC_DART: ${{ secrets.PUB_SEC_DART }}
      - name: Build Flutter App
        run: flutter build web --no-tree-shake-icons # TODO: Temporary until we replace material_design_icons_flutter
      - name: Prep public folder
        run: | 
          mkdir -p firebase/public
          mv build/web/* ./firebase/public
      - uses: FirebaseExtended/action-hosting-deploy@v0
        id: staging-deploy
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_GI_WEEKLY_MATERIAL_TRACKER }}'
          projectId: gi-weekly-material-tracker
          channelId: staging
          entrypoint: firebase
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
